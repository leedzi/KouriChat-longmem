<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KouriChat - 配置中心">
    <meta name="keywords" content="AI,KouriChat">
    <meta name="theme-color" content="#6366f1">
    <title>KouriChat - 配置中心</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdmirror.com/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/mom.ico">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #4f46e5;
            --background-color: #f0f4f8;  /* 更柔和的浅蓝灰色背景 */
            --text-color: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.494);
            --card-border: rgba(255, 255, 255, 0.5);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-bs-theme="dark"] {
            --background-color: #1a1f2e;  /* 更柔和的深色背景 */
            --text-color: #f8fafc;
            --card-bg: rgba(30, 41, 59, 0.612);
            --card-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        html,body{
            height:100%;
            margin: 0;
        }
        body {
            background: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .config-section {
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            border-radius: 1rem;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.5s ease forwards;
            animation-delay: 0.1s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 添加卡片微妙的装饰效果 */
        .config-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            opacity: 0.5;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--card-border) !important;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
            outline: none;
        }

        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            margin-left: -3.5em;
        }

        .form-label {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .badge-info {
            background: var(--primary-color);
            cursor: pointer;
        }

        .theme-switcher {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        .accordion-button {
            background: transparent;
            border: none;
        }

        .accordion-button:not(.collapsed) {
            background: rgba(var(--bs-primary-rgb), 0.1);
            color: var(--primary-color);
        }

        .accordion-item {
            background: transparent;
            border-color: var(--card-border);
        }

        .toast {
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .form-check-label {
            margin-top: 0;
        }

        /* 人设选择下拉栏样式 */
        select[name="AVATAR_DIR"] {
            max-height: 300px;
            overflow-y: auto;
        }


        .navbar .form-check.form-switch {
            display: flex;
            align-items: center;
            height: 100%;
            margin: 0;
        }


        .navbar .form-check-label {
            display: flex;
            align-items: center;
            margin: 0 0 0 8px;
            line-height: 1;
        }


        .navbar .form-check-input {
            margin: 0;
            vertical-align: middle;
        }

        /* 输入框组样式 */
        .input-group {
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .input-group .form-control {
            border: none !important;
        }

        /* 配置项容器样式 */
        .config-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 响应式布局 */
        @media (max-width: 700px) {
            .config-section {
                padding: 1rem;
            }
        }

        /* 密码输入框样式 */
        .password-input-group {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        /* 修改左右两栏的间距 */
        @media (min-width: 768px) {
            .col-md-6.pe-md-2 {
                padding-right: 1.5rem !important;  /* 增加右边距 */
            }
            
            .col-md-6.ps-md-2 {
                padding-left: 1.5rem !important;   /* 增加左边距 */
            }
        }

        /* 修改响应式布局下的间距 */
        @media (max-width: 767px) {
            .col-md-6 {
                margin-bottom: 2rem;  /* 增加上下间距 */
            }
            
            .config-section {
                margin-bottom: 0;  /* 移除原有的底部间距 */
            }
            
            /* 为了让背景更好地显示，增加内容区域的内边距 */
            main.container-fluid {
                padding: 2rem 1rem;  /* 调整移动端的内边距 */
            }
            
            /* 为底部保存按钮留出空间 */
            main.container-fluid {
                padding-bottom: 5rem;  /* 底部留出更多空间 */
            }
        }

        /* 优化桌面端布局 */
        @media (min-width: 768px) {
            .col-md-6.pe-md-2 {
                padding-right: 1.5rem !important;
            }
            
            .col-md-6.ps-md-2 {
                padding-left: 1.5rem !important;
            }
            
            main.container-fluid {
                padding: 2rem;
                padding-bottom: 5rem;  /* 为底部保存按钮留出空间 */
            }
        }

        /* 修改主容器的内边距 */
        main.container-fluid {
            padding: 2rem;  /* 增加整体内边距 */
        }

        /* 添加相同的基础样式 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1 0 auto;
            width: 100%;
            padding: 2rem 0;
        }

        /* 添加通知动画 */
        .toast {
            transition: all 0.3s ease;
            transform: translateY(-20px);
            opacity: 0;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* 优化按钮悬停效果 */
        .btn-outline-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 添加输入框过渡效果 */
        #customApiInput {
            transition: all 0.3s ease;
        }

        #customApiInput.show {
            transform: translateY(0);
            opacity: 1;
        }

        #customApiInput.hide {
            transform: translateY(-10px);
            opacity: 0;
        }

        /* 添加通知容器样式 */
        .notification-container {
            z-index: 1050;
        }

        .accordion-button {
            background: transparent !important;
        }
        
        .accordion-button:not(.collapsed) {
            color: rgb(147, 151, 255) !important;
        }
        
        .list-group-item {
            border: none;
            margin-bottom: 8px;
            border-radius: 8px !important;
            transition: all 0.3s ease;
        }
        
        /* 只针对定时任务的列表项应用深色样式 */
        #schedule-settings .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }
        
        #schedule-settings .list-group-item:hover {
            background: rgba(30, 41, 59, 0.8) !important;
            transform: translateX(5px);
        }
        
        /* 监听用户列表使用默认颜色 */
        #selected_users_LISTEN_LIST .list-group-item {
            background: var(--bs-list-group-bg);
            color: var(--bs-body-color);
        }
        
        /* 深色模式下的特定样式 */
        [data-bs-theme="dark"] #selected_users_LISTEN_LIST .list-group-item {
            background: rgba(30, 41, 59, 0.5);
            color: #fff;
        }
        
    </style>
    <script defer src="http://umami.kourichat.com/script.js" data-website-id="319cc5bc-c057-4f6c-8bc4-4af5e110add1"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/dark-mode.js"></script>
</head>
<body>
    {% include 'navbar.html' %}
    
    <main class="container-fluid py-4">
        <div class="row">
            <!-- 左侧基础配置 -->
            <div class="col-md-6 pe-md-2">
                <div class="config-section h-100">
                    <h4 class="mb-4 d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-gear-fill me-2"></i>基础配置
                        </div>
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#historyConfigModal">
                            <i class="bi bi-clock-history me-2"></i>历史配置
                        </button>
                    </h4>
                    <form id="configForm">
                        {% for group_name, configs in config_groups.items() %}
                            {% if group_name == '基础配置' %}
                            <div class="accordion mb-3">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#{{ group_name|replace(' ', '-') }}">
                                            {{ group_name }}
                                        </button>
                                    </h2>
                                    <div id="{{ group_name|replace(' ', '-') }}" class="accordion-collapse collapse show">
                                        <div class="accordion-body">
                                            {% for key, config in configs.items() %}
                                            <div class="mb-4">
                                                {% include 'config_item.html' %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </form>
                </div>
            </div>

            <!-- 右侧其他配置 -->
            <div class="col-md-6 ps-md-2">
                <div class="config-section h-100">
                    <h4 class="mb-4">
                        <i class="bi bi-sliders me-2"></i>高级配置
                    </h4>
                    <form id="otherConfigForm">
                        {% for group_name, configs in config_groups.items() %}
                            {% if group_name != '基础配置' and group_name != '定时任务配置' %}  {# 排除定时任务配置 #}
                            <div class="accordion mb-3">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#{{ group_name|replace(' ', '-') }}">
                                            {{ group_name }}
                                        </button>
                                    </h2>
                                    <div id="{{ group_name|replace(' ', '-') }}" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            {% for key, config in configs.items() %}
                                            <div class="mb-4">
                                                {% include 'config_item.html' %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}

                        <!-- 单独添加定时任务配置部分 -->
                        <div class="accordion mb-3">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#schedule-settings">
                                        定时任务配置
                                    </button>
                                </h2>
                                <div id="schedule-settings" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <!-- 定时任务配置的内容 -->
                                        <input type="hidden" 
                                               id="TASKS" 
                                               name="TASKS" 
                                               value='{{ tasks_json|safe }}'>
                                        
                                        <!-- 添加和管理任务的按钮 -->
                                        <div class="mb-3 list-group">
                                            <a href="#" class="list-group-item list-group-item-action" 
                                               data-bs-toggle="modal" data-bs-target="#addTaskModal"
                                               style="background: rgba(30, 41, 59, 0.5);">
                                                <i class="bi bi-plus-lg me-2"></i>
                                                添加定时任务
                                                <i class="bi bi-chevron-right float-end mt-1"></i>
                                            </a>
                                        </div>
                                        
                                        <!-- 任务列表管理按钮 -->
                                        <div class="mb-3 list-group">
                                            <a href="#" class="list-group-item list-group-item-action" 
                                               data-bs-toggle="modal" data-bs-target="#taskListModal"
                                               style="background: rgba(30, 41, 59, 0.5);">
                                                <i class="bi bi-list-ul me-2"></i>
                                                任务列表管理
                                                <i class="bi bi-chevron-right float-end mt-1"></i>
                                            </a>
                                        </div>
                                        
                                        <!-- 说明文字 -->
                                        <div class="text-muted small">
                                            <i class="bi bi-info-circle me-1"></i>
                                            可以添加定时发送消息的任务，支持Cron表达式和时间间隔两种方式
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 保存按钮固定在底部 -->
        <div class="position-fixed bottom-0 start-0 w-100 bg-body p-3 shadow-lg">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <button type="button" 
                            class="btn btn-primary btn-lg w-100" 
                            id="saveButton">
                            <i class="bi bi-save me-2"></i>保存所有设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast-container">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                <span class="toast-message"></span>
            </div>
        </div>
    </div>

    <!-- 在 body 标签下添加顶部通知区域 -->
    <div class="position-fixed top-0 start-50 translate-middle-x p-3 notification-container">
        <div id="saveNotification" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span id="saveNotificationMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭通知"></button>
            </div>
        </div>
    </div>

    <!-- 监听用户列表为空的确认对话框 -->
    <div class="modal fade" id="emptyListenListModal" tabindex="-1" aria-labelledby="emptyListenListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emptyListenListModalLabel">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>提示
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <p>您未填写监听用户，是否继续保存？</p>
                    <p class="text-muted small">未填写监听用户将导致机器人无法响应任何消息。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">否</button>
                    <button type="button" class="btn btn-secondary" id="confirmSaveBtn">是</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务列表模态框 -->
    <div class="modal fade" id="taskListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-list-check me-2"></i>定时任务列表
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div id="taskListContainer" class="list-group">
                        <!-- 默认显示无任务提示 -->
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox fs-2"></i>
                            <p class="mt-2">暂无定时任务</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加任务模态框 -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTaskModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>添加定时任务
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-key me-2"></i>任务ID
                            </label>
                            <input type="text" class="form-control" id="taskId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-person me-2"></i>发送对象
                            </label>
                            <select class="form-select" id="taskChatId" required>
                                <!-- 将通过JS动态填充 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-chat-text me-2"></i>消息内容
                            </label>
                            <textarea class="form-control" id="taskContent" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-alarm me-2"></i>定时类型
                            </label>
                            <select class="form-select" id="scheduleType" onchange="toggleScheduleInput()">
                                <option value="cron">Cron表达式</option>
                                <option value="interval">时间间隔</option>
                            </select>
                        </div>
                        <div id="intervalInputGroup" class="mb-3" style="display: none;">
                            <label class="form-label">
                                <i class="bi bi-hourglass-split me-2"></i>间隔时间（小时）
                            </label>
                            <input type="number" class="form-control" id="intervalHours" 
                                   min="0.1" step="0.1" placeholder="例如：1.5">
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                设置任务每隔多少小时执行一次：
                                <ul class="mb-0 mt-1">
                                    <li>0.5 = 每30分钟执行一次</li>
                                    <li>1 = 每1小时执行一次</li>
                                    <li>24 = 每天执行一次</li>
                                </ul>
                            </div>
                        </div>
                        <div id="cronInputGroup" class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-calendar3 me-2"></i>Cron表达式
                            </label>
                            <input type="text" class="form-control" id="cronExpression" 
                                   placeholder="例如：0 9 * * * (每天9点)">
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                格式：分 时 日 月 星期，常用示例：
                                <ul class="mb-0 mt-1">
                                    <li>0 9 * * * = 每天早上9点</li>
                                    <li>0 */2 * * * = 每2小时整点</li>
                                    <li>0 9-18 * * * = 每天9点到18点的整点</li>
                                </ul>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加历史配置模态框 -->
    <div class="modal fade" id="historyConfigModal" tabindex="-1" aria-labelledby="historyConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyConfigModalLabel">
                        <i class="bi bi-clock-history me-2"></i>历史配置
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="historyConfigList">
                        <!-- 历史配置列表将通过JavaScript动态填充 -->
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-inbox fs-2"></i>
                            <p class="mt-2">暂无历史配置记录</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在页面中添加隐藏的配置数据 -->
    <script id="config_data" type="application/json">
        {{ config_json|safe }}
    </script>

    <script>
        // 护眼模式切换
        function toggleDarkMode() {
            document.body.setAttribute('data-bs-theme', 
                document.body.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark');
        }

        // 初始化工具提示
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // 页面加载时初始化所有配置数据
        document.addEventListener('DOMContentLoaded', function() {
            // 获取最新的配置数据
            fetch('/get_all_configs')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 更新所有配置项
                        updateAllConfigs(data.configs);
                        
                        // 更新任务列表
                        const tasksInput = document.getElementById('TASKS');
                        if (tasksInput && data.tasks) {
                            tasksInput.value = JSON.stringify(data.tasks);
                            updateTaskList();
                        }
                    } else {
                        console.error('获取配置数据失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('获取配置数据请求失败:', error);
                    // 如果请求失败，使用页面加载时的初始数据
                    const tasksInput = document.getElementById('TASKS');
                    if (tasksInput) {
                        updateTaskList();
                    }
                });
            
            // 获取保存按钮
            const saveButton = document.getElementById('saveButton');
            
            // 添加点击事件监听器
            saveButton.addEventListener('click', function() {
                const mainForm = document.getElementById('configForm');
                const otherForm = document.getElementById('otherConfigForm');
                const config = {};
                
                // 获取所有表单数据
                const formData = new FormData(mainForm);
                
                // 处理表单数据
                for (let [key, value] of formData.entries()) {
                    processFormValue(config, key, value);
                }
                
                if (otherForm) {
                    const otherFormData = new FormData(otherForm);
                    for (let [key, value] of otherFormData.entries()) {
                        processFormValue(config, key, value);
                    }
                }

                // 特别处理任务数据 - 确保直接从隐藏字段获取
                const tasksInput = document.getElementById('TASKS');
                if (tasksInput) {
                    try {
                        const tasksValue = tasksInput.value;
                        if (tasksValue) {
                            // 解析为JSON对象并添加到配置中
                            config['TASKS'] = JSON.parse(tasksValue);
                        }
                    } catch (e) {
                        // 出错时使用空数组
                        config['TASKS'] = [];
                    }
                }

                // 特别检查温度值
                const temperatureSlider = document.getElementById('TEMPERATURE_slider');
                const temperatureInput = document.getElementById('TEMPERATURE');
                if (temperatureSlider && temperatureInput) {
                    const tempValue = parseFloat(temperatureSlider.value);
                    if (!isNaN(tempValue)) {
                        config['TEMPERATURE'] = tempValue;
                    }
                }

                // 检查页面上是否有用户列表元素
                const userListElement = document.getElementById('selected_users_LISTEN_LIST');
                const hasUsers = userListElement && userListElement.querySelectorAll('.list-group-item').length > 0;
                
                // 根据是否有用户决定是否显示确认对话框
                if (!hasUsers) {
                    // 创建确认对话框
                    const confirmDialog = new bootstrap.Modal(document.getElementById('emptyListenListModal'));
                    confirmDialog.show();
                    
                    // 设置确认按钮的事件
                    document.getElementById('confirmSaveBtn').onclick = function() {
                        confirmDialog.hide();
                        saveConfig(config);
                    };
                } else {
                    // 直接保存配置
                    saveConfig(config);
                }
            });

            // 初始化背景
            fetch('/get_background')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.path) {
                        document.body.style.backgroundImage = `url('${data.path}')`;
                    }
                })
                .catch(error => console.error('Error:', error));

            // 添加到现有的DOMContentLoaded事件处理程序中
            updateHistoryConfigList();
            
            // 为历史配置模态框添加显示事件
            document.getElementById('historyConfigModal').addEventListener('show.bs.modal', function() {
                updateHistoryConfigList();
            });
        });

        // 更新所有配置项的函数
        function updateAllConfigs(configs) {
            // 遍历所有配置组和配置项
            for (const groupKey in configs) {
                const group = configs[groupKey];
                for (const configKey in group) {
                    const config = group[configKey];
                    const element = document.getElementById(configKey);
                    if (element) {
                        // 根据元素类型设置值
                        if (element.type === 'checkbox') {
                            element.checked = config.value;
                        } else if (element.tagName === 'SELECT') {
                            element.value = config.value;
                        } else {
                            element.value = config.value;
                        }
                        
                        // 特殊处理滑块
                        const slider = document.getElementById(`${configKey}_slider`);
                        if (slider) {
                            slider.value = config.value;
                            const display = document.getElementById(`${configKey}_display`);
                            if (display) {
                                display.textContent = typeof config.value === 'number' ? 
                                    (configKey === 'TEMPERATURE' ? config.value.toFixed(1) : config.value) : 
                                    config.value;
                            }
                        }
                        
                        // 特殊处理用户列表
                        if (configKey === 'LISTEN_LIST' && Array.isArray(config.value)) {
                            const userListElement = document.getElementById(`selected_users_${configKey}`);
                            if (userListElement) {
                                userListElement.innerHTML = '';
                                config.value.forEach(user => {
                                    if (user) {
                                        const userDiv = document.createElement('div');
                                        userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                                        userDiv.innerHTML = `
                                            ${user}
                                            <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${configKey}', '${user}')">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        `;
                                        userListElement.appendChild(userDiv);
                                    }
                                });
                            }
                        }
                    }
                }
            }
        }

        // 修改保存配置到cookie的函数
        function saveConfigToCookie(config) {
            // 提取需要保存的关键配置
            const keyConfigs = {
                timestamp: new Date().toISOString(),
                LISTEN_LIST: config.LISTEN_LIST || [],
                DEEPSEEK_API_KEY: config.DEEPSEEK_API_KEY || '',
                DEEPSEEK_BASE_URL: config.DEEPSEEK_BASE_URL || '',
                MODEL: config.MODEL || '',
                MOONSHOT_API_KEY: config.MOONSHOT_API_KEY || ''
            };
            
            // 检查是否有有效数据
            const hasValidData = 
                (keyConfigs.LISTEN_LIST && keyConfigs.LISTEN_LIST.length > 0) || 
                keyConfigs.DEEPSEEK_API_KEY || 
                keyConfigs.DEEPSEEK_BASE_URL ||
                keyConfigs.MODEL || 
                keyConfigs.MOONSHOT_API_KEY;
            
            if (!hasValidData) {
                console.log('没有有效数据，不保存到cookie');
                return;
            }
            
            // 获取现有的历史配置
            let historyConfigs = getCookieConfigs();
            
            // 检查是否已存在相同配置
            const isDuplicate = historyConfigs.some(item => 
                JSON.stringify([
                    item.LISTEN_LIST, 
                    item.DEEPSEEK_API_KEY, 
                    item.DEEPSEEK_BASE_URL,
                    item.MODEL, 
                    item.MOONSHOT_API_KEY
                ]) === 
                JSON.stringify([
                    keyConfigs.LISTEN_LIST, 
                    keyConfigs.DEEPSEEK_API_KEY, 
                    keyConfigs.DEEPSEEK_BASE_URL,
                    keyConfigs.MODEL, 
                    keyConfigs.MOONSHOT_API_KEY
                ])
            );
            
            if (isDuplicate) {
                console.log('配置已存在，不重复保存');
                return;
            }
            
            // 限制历史记录数量为10条
            if (historyConfigs.length >= 10) {
                historyConfigs.pop(); // 移除最旧的配置
            }
            
            // 添加新配置到历史记录开头
            historyConfigs.unshift(keyConfigs);
            
            // 保存到cookie，有效期30天
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            document.cookie = `historyConfigs=${JSON.stringify(historyConfigs)};expires=${expiryDate.toUTCString()};path=/`;
            
            // 更新历史配置列表显示
            updateHistoryConfigList();
        }

        // 从cookie获取历史配置
        function getCookieConfigs() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('historyConfigs='));
            
            if (cookieValue) {
                try {
                    return JSON.parse(cookieValue.split('=')[1]);
                } catch (e) {
                    console.error('解析历史配置失败:', e);
                    return [];
                }
            }
            
            return [];
        }

        // 修改历史配置列表显示函数，添加更多信息显示
        function updateHistoryConfigList() {
            const historyConfigs = getCookieConfigs();
            const container = document.getElementById('historyConfigList');
            
            if (!container) return;
            
            if (historyConfigs.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="bi bi-inbox fs-2"></i>
                        <p class="mt-2">暂无历史配置记录</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = historyConfigs.map((config, index) => {
                const date = new Date(config.timestamp);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="me-auto">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge bg-primary me-2">配置 #${index + 1}</span>
                                    <small class="text-muted">${formattedDate}</small>
                                </div>
                                <div class="mb-1">监听用户: ${config.LISTEN_LIST.join(', ') || '无'}</div>
                                <div class="mb-1">AI模型: ${config.MODEL || '未设置'}</div>
                                <div class="mb-1">API Base URL: ${config.DEEPSEEK_BASE_URL || '未设置'}</div>
                                <div class="mb-1">API密钥: ${config.DEEPSEEK_API_KEY ? '已设置' : '未设置'}</div>
                                <div class="mb-1">Moonshot密钥: ${config.MOONSHOT_API_KEY ? '已设置' : '未设置'}</div>
                            </div>
                            <div>
                                <button class="btn btn-danger btn-sm me-2" onclick="deleteHistoryConfig(${index})">
                                    <i class="bi bi-trash me-1"></i>删除
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="applyHistoryConfig(${index})">
                                    <i class="bi bi-arrow-clockwise me-1"></i>应用
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 修改应用历史配置函数
        function applyHistoryConfig(index) {
            const historyConfigs = getCookieConfigs();
            if (index >= historyConfigs.length) return;
            
            const config = historyConfigs[index];
            
            // 应用监听用户列表
            if (config.LISTEN_LIST && Array.isArray(config.LISTEN_LIST)) {
                const userListElement = document.getElementById('selected_users_LISTEN_LIST');
                const listenListInput = document.getElementById('LISTEN_LIST');
                
                if (userListElement && listenListInput) {
                    // 清空现有用户
                    userListElement.innerHTML = '';
                    
                    // 添加历史用户
                    config.LISTEN_LIST.forEach(user => {
                        if (user) {
                            const userDiv = document.createElement('div');
                            userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                            userDiv.innerHTML = `
                                ${user}
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('LISTEN_LIST', '${user}')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            `;
                            userListElement.appendChild(userDiv);
                        }
                    });
                    
                    // 更新隐藏输入框
                    listenListInput.value = config.LISTEN_LIST.join(',');
                }
            }
            
            // 应用DeepSeek API密钥
            if (config.DEEPSEEK_API_KEY) {
                const apiKeyInput = document.getElementById('DEEPSEEK_API_KEY') || 
                                   document.querySelector('input[name="DEEPSEEK_API_KEY"]');
                if (apiKeyInput) {
                    apiKeyInput.value = config.DEEPSEEK_API_KEY;
                }
            }
            
            // 应用DeepSeek Base URL
            if (config.DEEPSEEK_BASE_URL) {
                const baseUrlInput = document.getElementById('DEEPSEEK_BASE_URL');
                const apiProviderSelect = document.getElementById('api_provider_select');
                const customApiInput = document.getElementById('customApiInput');
                
                if (baseUrlInput && apiProviderSelect) {
                    baseUrlInput.value = config.DEEPSEEK_BASE_URL;
                    
                    // 检查是否是预定义的URL
                    const matchingOption = Array.from(apiProviderSelect.options).find(opt => {
                        return opt.dataset.url === config.DEEPSEEK_BASE_URL;
                    });
                    
                    if (matchingOption) {
                        apiProviderSelect.value = matchingOption.value;
                        if (customApiInput) {
                            customApiInput.style.display = 'none';
                        }
                    } else {
                        apiProviderSelect.value = 'custom';
                        if (customApiInput) {
                            customApiInput.style.display = 'block';
                            const input = customApiInput.querySelector('input');
                            if (input) {
                                input.value = config.DEEPSEEK_BASE_URL;
                            }
                        }
                    }
                }
            }
            
            // 应用模型
            if (config.MODEL) {
                const modelInput = document.getElementById('MODEL');
                const modelSelect = document.getElementById('model_select');
                if (modelInput) {
                    modelInput.value = config.MODEL;
                    if (modelSelect) {
                        modelSelect.value = config.MODEL;
                        if (!Array.from(modelSelect.options).some(opt => opt.value === config.MODEL)) {
                            modelSelect.value = 'custom';
                            const customModelInput = document.getElementById('customModelInput');
                            if (customModelInput) {
                                customModelInput.style.display = 'block';
                                const input = customModelInput.querySelector('input');
                                if (input) input.value = config.MODEL;
                            }
                        }
                    }
                }
            }
            
            // 应用Moonshot API密钥
            if (config.MOONSHOT_API_KEY) {
                const imgApiKeyInput = document.getElementById('MOONSHOT_API_KEY') || 
                                      document.querySelector('input[name="MOONSHOT_API_KEY"]');
                if (imgApiKeyInput) {
                    imgApiKeyInput.value = config.MOONSHOT_API_KEY;
                }
            }
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('historyConfigModal'));
            if (modal) modal.hide();
            
            // 显示提示
            showSaveNotification('已应用历史配置，请点击保存按钮保存更改');
            
            // 更新任务对话框中的发送对象选项
            updateTaskChatIdOptions();
        }

        // 修改保存配置的函数，添加保存到cookie的功能
        function saveConfig(config) {
            // 发送保存请求
            fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 保存成功后，将配置保存到cookie
                    saveConfigToCookie(config);
                    showSaveNotification(data.message);
                } else {
                    showSaveNotification(data.message, 'error');
                }
            });
        }

        function processFormValue(config, key, value) {
            if (key === 'LISTEN_LIST') {
                config[key] = value.split(',').map(item => item.trim()).filter(item => item);
            } else if (key === 'TEMPERATURE') {
                // 特殊处理温度参数
                const tempValue = parseFloat(value);
                if (!isNaN(tempValue)) {
                    config[key] = tempValue;
                }
            } else if (key === 'TASKS') {
                try {
                    config[key] = JSON.parse(value);
                } catch (e) {
                    config[key] = [];
                }
            } else if (value.toLowerCase() === 'true' || value.toLowerCase() === 'false') {
                config[key] = value.toLowerCase() === 'true';
            } else if (!isNaN(value) && value !== '') {
                config[key] = Number(value);
            } else {
                config[key] = value;
            }
        }

        // 添加新函数
        function addToListFromSelect(key, value) {
            if (value === 'add_new') {
                document.getElementById('new_input_' + key).style.display = 'flex';
                setTimeout(() => {
                    document.querySelector(`select[onchange*="${key}"]`).value = '';
                }, 100);
                return;
            }
            
            if (value) {
                const targetElement = document.getElementById(key);
                const currentValues = targetElement.value ? targetElement.value.split(',') : [];
                if (!currentValues.includes(value)) {
                    currentValues.push(value);
                    targetElement.value = currentValues.join(',');
                    
                    // 添加到用户列表显示
                    const userListElement = document.getElementById('selected_users_' + key);
                    const userDiv = document.createElement('div');
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${value}
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${key}', '${value}')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild(userDiv);
                }
            }
        }

        function addNewUser(key) {
            const inputElement = document.getElementById('input_' + key);
            const newValue = inputElement.value.trim();
            
            if (newValue) {
                const targetElement = document.getElementById(key);
                const currentValues = targetElement.value ? targetElement.value.split(',') : [];
                if (!currentValues.includes(newValue)) {
                    currentValues.push(newValue);
                    targetElement.value = currentValues.join(',');
                    
                    // 添加到用户列表显示
                    const userListElement = document.getElementById('selected_users_' + key);
                    const userDiv = document.createElement('div');
                    userDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
                    userDiv.innerHTML = `
                        ${newValue}
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('${key}', '${newValue}')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    `;
                    userListElement.appendChild(userDiv);
                    
                    // 清空输入框
                    inputElement.value = '';
                }
            }
            updateTaskChatIdOptions();
        }

        function removeUser(key, userToRemove) {
            const targetElement = document.getElementById(key);
            const userListElement = document.getElementById('selected_users_' + key);
            
            // 更新隐藏的input值
            let currentValues = targetElement.value ? targetElement.value.split(',') : [];
            currentValues = currentValues.filter(user => user !== userToRemove);
            targetElement.value = currentValues.join(',');
            
            // 从显示列表中移除
            const userElements = userListElement.getElementsByClassName('list-group-item');
            for (let element of userElements) {
                if (element.textContent.trim() === userToRemove) {
                    element.remove();
                    break;
                }
            }
            updateTaskChatIdOptions();
        }

        // 添加背景图片上传处理
        document.getElementById('backgroundInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('background', file);
                
                fetch('/upload_background', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.body.style.backgroundImage = `url('${data.path}')`;
                        showToast(data.message, 'success');
                    } else {
                        showToast(data.message, 'danger');
                    }
                })
                .catch(error => {
                    showToast('上传失败：' + error, 'danger');
                });
            }
        });

        function updateTemperature(key, value) {
            const displayElement = document.getElementById(key + '_display');
            if (displayElement) {
                displayElement.classList.add('updating');
                displayElement.textContent = parseFloat(value).toFixed(1);

                setTimeout(() => {
                    displayElement.classList.remove('updating');
                }, 300);
            }
        }

        function showSaveNotification(message, type = 'success') {
            const notification = document.getElementById('saveNotification');
            const messageElement = document.getElementById('saveNotificationMessage');
            
            // 移除现有的背景色类
            notification.classList.remove('bg-success', 'bg-danger');
            
            // 根据类型设置样式
            if (type === 'success') {
                notification.classList.add('bg-success');
            } else {
                notification.classList.add('bg-danger');
            }
            
            messageElement.textContent = message;
            
            const toast = new bootstrap.Toast(notification, {
                animation: true,
                autohide: true,
                delay: 3000
            });
            toast.show();
        }

        // 修改显示添加任务模态框时的处理
        document.getElementById('addTaskModal').addEventListener('show.bs.modal', function () {
            // 重置表单
            document.getElementById('taskForm').reset();
            
            // 填充发送对象下拉框
            const chatSelect = document.getElementById('taskChatId');
            chatSelect.innerHTML = '<option value="">请选择发送对象</option>';
            
            // 从监听列表获取用户
            const userElements = document.querySelectorAll('#selected_users_LISTEN_LIST .list-group-item');
            userElements.forEach(element => {
                const userName = element.textContent.trim();
                if (userName) {
                    chatSelect.innerHTML += `<option value="${userName}">${userName}</option>`;
                }
            });
            
            // 默认显示cron输入框
            toggleScheduleInput();
        });

        // 添加一个函数来更新任务对话框中的发送对象选项
        function updateTaskChatIdOptions() {
            const chatSelect = document.getElementById('taskChatId');
            if (chatSelect) {
                const currentValue = chatSelect.value;
                chatSelect.innerHTML = '<option value="">请选择发送对象</option>';
                
                const userElements = document.querySelectorAll('#selected_users_LISTEN_LIST .list-group-item');
                userElements.forEach(element => {
                    const userName = element.textContent.trim();
                    if (userName) {
                        chatSelect.innerHTML += `<option value="${userName}">${userName}</option>`;
                    }
                });
                
                // 保持原来选中的值
                if (currentValue) {
                    chatSelect.value = currentValue;
                }
            }
        }

        // 添加保存任务的函数
        function saveTask() {
            const taskId = document.getElementById('taskId').value.trim();
            const chatId = document.getElementById('taskChatId').value;
            const content = document.getElementById('taskContent').value.trim();
            const scheduleType = document.getElementById('scheduleType').value;
            
            // 验证必填字段
            if (!taskId || !chatId || !content) {
                showSaveNotification('请填写所有必填字段', 'error');
                return;
            }
            
            const task = {
                task_id: taskId,
                chat_id: chatId,
                content: content,
                schedule_type: scheduleType,
                is_active: true
            };
            
            // 根据调度类型设置相应的值
            if (scheduleType === 'cron') {
                const cronExp = document.getElementById('cronExpression').value.trim();
                if (!cronExp) {
                    showSaveNotification('请输入Cron表达式', 'error');
                    return;
                }
                task.schedule_time = cronExp;
            } else {
                const hours = parseFloat(document.getElementById('intervalHours').value);
                if (!hours || hours <= 0) {
                    showSaveNotification('请输入有效的间隔时间', 'error');
                    return;
                }
                task.schedule_time = (hours * 3600).toString(); // 转换为秒并存储为字符串
            }
            
            // 获取现有的任务列表
            let tasks = [];
            try {
                const tasksInput = document.getElementById('TASKS');
                if (tasksInput && tasksInput.value) {
                    tasks = JSON.parse(tasksInput.value);
                }
            } catch (e) {
                console.error('解析任务列表失败:', e);
            }
            
            // 更新任务列表
            const existingIndex = tasks.findIndex(t => t.task_id === taskId);
            if (existingIndex >= 0) {
                tasks[existingIndex] = task;
            } else {
                tasks.push(task);
            }
            
            // 更新隐藏输入框的值
            document.getElementById('TASKS').value = JSON.stringify(tasks);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
            modal.hide();
            
            // 显示成功提示
            showSaveNotification('任务已添加，请点击底部的"保存所有设置"按钮保存更改');
            
            // 刷新任务列表
            updateTaskList();
        }

        // 修改更新任务列表的函数
        function updateTaskList() {
            const container = document.getElementById('taskListContainer');
            if (!container) return;
            
            // 获取任务列表
            let tasks = [];
            try {
                const tasksInput = document.getElementById('TASKS');
                if (tasksInput && tasksInput.value) {
                    tasks = JSON.parse(tasksInput.value);
                }
            } catch (e) {
                console.error('解析任务列表失败:', e);
            }
            
            // 更新显示
            container.innerHTML = tasks.length === 0 ? `
                <div class="text-center text-muted p-4">
                    <i class="bi bi-inbox fs-2"></i>
                    <p class="mt-2">暂无定时任务</p>
                </div>
            ` : tasks.map(task => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-auto">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-primary me-2">${task.task_id}</span>
                                <small class="text-muted">${task.schedule_type === 'cron' ? 
                                    `Cron: ${task.schedule_time}` : 
                                    `每 ${task.schedule_time.split(':')[0]}:${task.schedule_time.split(':')[1]}`}</small>
                            </div>
                            <div class="mb-1">发送给：${task.chat_id}</div>
                            <small class="text-muted">${task.content}</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.task_id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？')) {
                // 获取当前任务列表
                let tasks = [];
                try {
                    const tasksInput = document.getElementById('TASKS');
                    if (tasksInput && tasksInput.value) {
                        tasks = JSON.parse(tasksInput.value);
                    }
                } catch (e) {
                    return;
                }
                
                // 删除指定任务
                tasks = tasks.filter(t => t.task_id !== taskId);
                
                // 更新隐藏输入框的值
                document.getElementById('TASKS').value = JSON.stringify(tasks);
                
                // 刷新任务列表显示
                updateTaskList();
                
                showSaveNotification('任务已删除，请点击底部的"保存所有设置"按钮保存更改');
            }
        }

        // 添加切换调度类型输入框的函数
        function toggleScheduleInput() {
            const scheduleType = document.getElementById('scheduleType').value;
            const cronInput = document.getElementById('cronExpression').parentElement;
            const intervalInput = document.getElementById('intervalHours').parentElement;
            
            if (scheduleType === 'cron') {
                cronInput.style.display = 'block';
                intervalInput.style.display = 'none';
            } else {
                cronInput.style.display = 'none';
                intervalInput.style.display = 'block';
            }
        }

        // 添加删除历史配置的函数
        function deleteHistoryConfig(index) {
            // 获取现有的历史配置
            let historyConfigs = getCookieConfigs();
            
            if (index >= 0 && index < historyConfigs.length) {
                // 删除指定索引的配置
                historyConfigs.splice(index, 1);
                
                // 更新cookie
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 30);
                document.cookie = `historyConfigs=${JSON.stringify(historyConfigs)};expires=${expiryDate.toUTCString()};path=/`;
                
                // 更新显示
                updateHistoryConfigList();
                
                // 显示提示
                showSaveNotification('历史配置已删除');
            }
        }
    </script>
</body>
</html>
